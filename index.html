<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Hello World</title>
	</head>
	<script src="pixi.min.js"></script>
	<body>
		<br><br>
		<script type="text/javascript">

// websocket script -----------
var HOST = location.origin.replace(/^http/, 'ws')
var ws = new WebSocket(HOST);
const MSG_TYPE_POSITION = "player position";
const MSG_TYPE_POSITION_ALL = "all player position";
const MSG_TYPE_NEW_CONNECTION = "new player connection";
const MSG_TYPE_REQUEST_PLAYERS = "request all players";
const MSG_TYPE_SEND_PLAYERS = "send all players";
const MSG_TYPE_REQUEST_NAME = "request player name";
const MSG_TYPE_SEND_NAME = "send player name";
const MSG_TYPE_REQUEST_FINISHED_SETUP = "request finished setup";
const MSG_TYPE_SEND_FINISHED_SETUP = "send finished setup";
let playerName = "";

// message from server
ws.onmessage = function(event){
  const parsedMsg = JSON.parse(event.data);

  // update all player positions
  if(parsedMsg.type==MSG_TYPE_POSITION_ALL){
    if(ws.readyState===ws.OPEN && finishedSetup){
      parsedMsg.msg.forEach((otherPlayer)=>{
        if(otherPlayer.id!=playerName){
          otherSprites[otherPlayer.id].position.x=otherPlayer.x;
          otherSprites[otherPlayer.id].position.y=otherPlayer.y;
        }
      });
    }
  }
  // new connection => create new sprite
  else if(parsedMsg.type==MSG_TYPE_NEW_CONNECTION){
    if(ws.readyState===ws.OPEN && finishedSetup){
      console.log("OPEN connection");
      newPlayer(parsedMsg.text);
    }
  }
  // received after client requests all players
  else if(parsedMsg.type==MSG_TYPE_SEND_PLAYERS){
    parsedMsg.msg.forEach((player)=>{
      if(player!=playerName){
        if(ws.readyState===ws.OPEN && finishedSetup){
          console.log("OPEN2 connection");
          newPlayer(player);
        }
      }
    });
  }
  // received after client requests name
  else if(parsedMsg.type==MSG_TYPE_SEND_NAME){
    playerName = parsedMsg.text;
  }
  else if(parsedMsg.type==MSG_TYPE_REQUEST_FINISHED_SETUP){
    loadTextures();
    const msg={
      type: MSG_TYPE_SEND_FINISHED_SETUP,
      text: finishedSetup
    }
    ws.send(JSON.stringify(msg));
  }
}

// used when user is connected for first time
function newPlayer(playerID){
  newSprite = new PIXI.Sprite(PIXI.loader.resources["red-square.png"].texture);
  app.stage.addChild(newSprite);
  otherSprites[playerID] = newSprite;
  newSprite.position.x=100;
  newSprite.position.y=100;
}

function requestName(){
  const msg={
    type: MSG_TYPE_REQUEST_NAME
  };
  ws.send(JSON.stringify(msg));
}

// request all existing players from server when loaded
function requestPlayers(){
  const msg = {
    type: MSG_TYPE_REQUEST_PLAYERS
  }
  ws.send(JSON.stringify(msg));
}

function msgPlayerPosition(){
  const msg = {
    position : {
      x: playerSprite.position.x,
      y: playerSprite.position.y
    },
    type : MSG_TYPE_POSITION
  };
  return JSON.stringify(msg);
}

// game script -------
let app = new PIXI.Application({width: 1280, height: 720});
let playerSprite = null;
let otherSprites = [];
const speed = 5;
let moveDirection = null;
let lastTime = Date.now();
let tickCooldown = false;
let finishedSetup = false;
let loadingFiles = false;

const KEYCODE_W = 87, KEYCODE_A = 65, KEYCODE_S = 83, KEYCODE_D = 68;
const keyW=keyboard(KEYCODE_W), keyA=keyboard(KEYCODE_A), keyS=keyboard(KEYCODE_S),
      keyD=keyboard(KEYCODE_D);
let keys = [keyW,keyA,keyS,keyD];

loadTextures();

function loadTextures(){
  if(ws.readyState===ws.OPEN && finishedSetup===false && !loadingFiles){
    console.log("open connection and finished setup");
    loadingFiles = true;
    PIXI.loader
      .add(["red-square.png",
            "blue-square.png"])
      .load(setup);
  }
  else if(ws.readyState!==ws.OPEN) console.log("connection not open");
  else if(finishedSetup) console.log("finished setup");
}

// init
function setup(){

  playerSprite = new PIXI.Sprite(PIXI.loader.resources["red-square.png"].texture);

  app.renderer.backgroundColor=0xFFFFFF;
  app.stage.addChild(playerSprite);
  app.ticker.add(mainLoop);

  playerSprite.position.x=100;
  playerSprite.position.y=100;

  requestName();

  requestPlayers();
  finishedSetup = true;
  loadingFiles = false;

}

// Game render loop
function mainLoop(delta){


  app.stage.pivot.x = playerSprite.position.x;
  app.stage.pivot.y = playerSprite.position.y;
  app.stage.position.x = app.renderer.width/2;
  app.stage.position.y = app.renderer.height/2;

  //update every 100 ms
  const currTime = Date.now();
  if(currTime - lastTime > 10){
    tickCooldown = true;
    lastTime = currTime;
  }
  else{
    tickCooldown = false;
  }

  if((keyW.isDown||keyA.isDown||keyS.isDown||keyD.isDown) && tickCooldown){
    ws.send(msgPlayerPosition());
  }

  if(keyW.isDown){
    playerSprite.y-=speed*delta;
  }
  if(keyA.isDown)playerSprite.x-=speed*delta;
  if(keyS.isDown)playerSprite.y+=speed*delta;
  if(keyD.isDown)playerSprite.x+=speed*delta;

};

// from https://github.com/kittykatattack/learningPixi#keyboard
function keyboard(keyCode) {
	let key = {};
	key.code = keyCode;
	key.isDown = false;
	key.isUp = true;
	key.press = undefined;
	key.release = undefined;
	//The `downHandler`
	key.downHandler = event => {
		if (event.keyCode === key.code) {
			if (key.isUp && key.press) key.press();
			key.isDown = true;
			key.isUp = false;
		}
		event.preventDefault();
	};

	//The `upHandler`
	key.upHandler = event => {
		if (event.keyCode === key.code) {
			if (key.isDown && key.release) key.release();
			key.isDown = false;
			key.isUp = true;
		}
		event.preventDefault();
	};

	//Attach event listeners
	window.addEventListener(
			"keydown", key.downHandler.bind(key), false
			);
	window.addEventListener(
			"keyup", key.upHandler.bind(key), false
			);
	return key;
}

document.body.appendChild(app.view);

		</script>
	</body>
</html>

<style>
body{
	text-align:center;
}
</style>
